<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù¾Ú† Ù¾Ú†</title>
  <link rel="icon" type="image/png" href="assets/images/ui/logo 2.png">
  <link rel="shortcut icon" type="image/png" href="assets/images/ui/logo 2.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.88.2/phaser.min.js"></script>
  <style>
    @font-face {
      font-family: 'DigiSarvenaz';
      src: url('assets/font/Digi Sarvenaz_0.ttf') format('truetype');
      font-display: swap;
    }
    
    html,body{height:100%;margin:0;padding:0;overflow:hidden;background:#000;font-family: 'DigiSarvenaz', Arial, sans-serif;}
/* Game container styles */
#game-wrapper {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background: #000;
  max-width: 450px; /* Ø­Ø¯Ø§Ú©Ø«Ø± Ø¹Ø±Ø¶ Ø¨Ø±Ø§ÛŒ Ø¯Ø³Ú©ØªØ§Ù¾ */
  max-height: 100vh;
}

#game-container {
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  background: #000;
}

@media (min-width: 769px) {
  #game-wrapper {
    max-width: 450px;
    width: 450px;
    height: 100vh;
  }
  #game-container {
    width: 450px !important;
    height: 100vh !important;
  }
}
    
    /* Welcome Screen */
    #welcome-screen{
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:#000000;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      z-index:1001;color:#fff;
    }
    .welcome-logo{
      width:120px;height:120px;margin-bottom:30px;
      background:url('assets/images/ui/logo 002_vz.png') center/contain no-repeat;
      animation:pulse 2s ease-in-out infinite;
    }
    .welcome-title{
      font-size:28px;font-weight:bold;margin-bottom:30px;
      text-shadow:0 2px 4px rgba(0,0,0,0.5);
      color:#fff;
    }
    .phone-input-container{
      margin-bottom:30px;
    }
    .phone-input-container input{
      padding:12px 20px;
      font-size:16px;
      border:none;
      border-radius:8px;
      text-align:center;
      direction:ltr;
      width:200px;
    }
    .phone-input-container label{
      display:block;
      margin-bottom:10px;
      font-size:16px;
      color:#fff;
    }
    .start-btn{
      padding:15px 30px;
      background:#fff;
      color:#000;
      border:none;
      border-radius:8px;
      font-size:18px;
      cursor:pointer;
      transition:all 0.5s;
      font-weight:bold;
      font-family: 'DigiSarvenaz', Arial, sans-serif;
    }
    .start-btn:hover{
      background:#f0f0f0;
      transform:scale(1.05);
    }
    
    /* Loading Screen */
    #loading-screen{
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:#000000;
      display:none;flex-direction:column;align-items:center;justify-content:center;
      z-index:1000;color:#fff;
    }
    .loading-logo{
      width:100px;height:100px;margin-bottom:30px;
      background:url('assets/images/ui/logo 002_vz.png') center/contain no-repeat;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform:scale(1); opacity:1; }
      50% { transform:scale(1.1); opacity:0.8; }
    }
    .loading-bar{
      width:300px;height:6px;background:rgba(255,255,255,0.3);border-radius:10px;overflow:hidden;margin-bottom:20px;
    }
    .loading-progress{
      width:0%;height:100%;background:linear-gradient(90deg,#00ff88,#00ccff);
      transition:width 0.3s ease;border-radius:10px;
      box-shadow:0 0 20px rgba(0,255,136,0.5);
    }
    .loading-text{
      font-size:18px;margin-bottom:10px;text-shadow:0 2px 4px rgba(0,0,0,0.5);
    }
    .loading-tip{
      font-size:14px;opacity:0.8;text-align:center;max-width:400px;line-height:1.6;
    }
    
    /* UI elements */
.ui-top-left {
  position: absolute;
  left: 40px;
  top: 60px;
  color: #FFA500;
  font-weight: 700;
  z-index: 50;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
  font-size: 20px;
  background: rgba(0, 0, 0, 0.45); 
  padding: 6px 10px; 
  border-radius: 6px; 
}

.ui-top-right {
  position: absolute;
  right: 40px;
  top:60px;
  z-index: 50;
  background: rgba(0,0,0,0.45);
  padding: 6px 8px;
  border-radius: 6px;
  color: #FFA500;
  font-size: 12px;
}
.ui-top-right .row {
  display: flex;
  align-items: center;
  min-width: 96px;
  gap: 5px;
}
    .hearts{display:flex;gap:3px}
    .heart{width:20px;height:20px;background:url('assets/images/ui/heart_vz.png') center/contain no-repeat;}
    .heart.empty{opacity:0.8;filter:grayscale(100%);}
    .ui-speed{position:absolute;left:40px;bottom:80px;z-index:50;background:rgba(0,0,0,0.45);padding:6px 8px;border-radius:6px;color:#fff;font-size:12px}
.ui-powerup {
  position: absolute;
  left: 50%;
  top: 15%; 
  transform: translateX(-60%);
  z-index: 60;
  background: linear-gradient(135deg,#f1c40f,#f39c12);
  color: #fff;
  padding: 3px 6px;
  border-radius: 15px;
  font-size: 10px;
  font-weight: bold;
  display: none;
  animation: powerupPulse 0.5s ease-in-out infinite alternate;
  box-shadow: 0 2px 8px rgba(241,196,15,0.4);
}
    @keyframes powerupPulse{
      from{transform:translateX(-50%) scale(1);}
      to{transform:translateX(-50%) scale(1.05);}
    }
    #game-over{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      z-index:60;display:none;min-width:90%;max-width:450px;
      background:rgba(0,0,0,0.95);color:#fff;padding:30px;border-radius:15px;
      text-align:center;border:3px solid #3498db;
      box-shadow:0 10px 30px rgba(0,0,0,0.7);
    }
    #game-over .game-over-logo{
      width:80px;height:80px;margin:0 auto 20px auto;
      background:url('assets/images/ui/logo 002_vz.png') center/contain no-repeat;
    }
    #game-over h2{margin:10px 0 20px 0;font-size:24px;color:#e74c3c}
    #game-over p{margin:8px 0;font-size:18px}
    .btn{display:inline-block;padding:12px 20px;border-radius:8px;margin:10px 8px;cursor:pointer;border:none;font-size:16px;transition:all 0.3s;font-weight:bold}
    .btn-primary{background:#2ecc71;color:#fff}
    .btn-primary:hover{background:#27ae60;transform:scale(1.05)}
    .btn-muted{background:#34495e;color:#fff}
    .btn-muted:hover{background:#2c3e50;transform:scale(1.05)}
    #game-over-leaderboard{
      margin:20px 0;background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;
      max-height:300px;overflow-y:auto;
    }
    #game-over-leaderboard h4{margin:0 0 15px 0;font-size:16px;color:#f1c40f;text-shadow:0 1px 2px rgba(0,0,0,0.8)}
    #game-over-leaderboard .entry{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);font-size:14px}
    #game-over-leaderboard .entry:last-child{border-bottom:none}
    #game-over-leaderboard .entry.current-player{background:rgba(241,196,15,0.3);border-radius:6px;padding:8px 12px;font-weight:bold}
    .player-rank{font-weight:bold;color:#f1c40f;min-width:40px}
    .entry-score{color:#3498db;font-weight:bold}
    .player-name{flex:1;text-align:center}
    #leaderboard{display:none}
    canvas{touch-action:manipulation}
    
    .game-completed{
      background:rgba(0,0,0,0.9);
      color:#fff;
      padding:30px;
      border-radius:15px;
      text-align:center;
      border:3px solid #f1c40f;
      box-shadow:0 10px 30px rgba(0,0,0,0.7);
    }
    
    @media (max-width: 480px) {
      .ui-top-left, .ui-top-right, .ui-speed { font-size: 10px; }
      .loading-bar { width: 250px; }
      .loading-text { font-size: 16px; }
      #game-over { min-width: 95%; padding: 20px; }
      #game-over h2 { font-size: 20px; }
      #game-over p { font-size: 16px; }
      .btn { padding: 10px 16px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <!-- Welcome Screen -->
  <div id="welcome-screen">
    <div class="welcome-logo"></div>
    <div class="welcome-title">Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ Ù¾Ú† Ù¾Ú† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</div>
    <div class="phone-input-container" id="phone-container">
      <label for="phone-input">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</label>
      <input type="tel" id="phone-input" placeholder="09xxxxxxxxx" maxlength="11">
    </div>
    <button class="start-btn" id="start-game-btn">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
  </div>

  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="loading-logo"></div>
    <div class="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    <div class="loading-bar">
      <div class="loading-progress" id="loading-progress"></div>
    </div>
    <div class="loading-tip">
      ğŸ’¡Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¨Ø± Ú†Ù¾ Ùˆ Ø±Ø§Ø³Øª ØµÙØ­Ù‡ Ù…Ø§Ø´ÛŒÙ† Ø±Ø§ Ø­Ø±Ú©Øª Ø¨Ø¯ÛŒØ¯
    </div>
  </div>

  <div id="game-wrapper" style="display:none;">
    <div id="game-container"></div>
    <div class="ui-top-left" id="ui-score">Ø§Ù…ØªÛŒØ§Ø²: 0</div>
    <div class="ui-top-right" id="ui-lives">
      <div class="row">
        Ø¬Ø§Ù†: <span id="lives-count">3</span>
        <div class="hearts" id="hearts-container">
          <div class="heart"></div>
          <div class="heart"></div>
          <div class="heart"></div>
        </div>
      </div>
    </div>
    <div class="ui-powerup" id="ui-powerup">â­ Ø§Ù…ØªÛŒØ§Ø² Ø¯ÙˆØ¨Ø±Ø§Ø¨Ø± ÙØ¹Ø§Ù„!</div>
    <div class="ui-speed" id="ui-speed">Ø³Ø±Ø¹Øª: 1.0</div>
    <div id="game-over">
      <div class="game-over-logo"></div>
      <h2>ğŸ Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯!</h2>
      <p id="final-score">Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ: 0</p>
      <p id="player-rank-display"></p>
      <div id="game-over-leaderboard">
        <h4>ğŸ† Ø¬Ø¯ÙˆÙ„ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø¨Ø±ØªØ±</h4>
        <div id="game-over-leaderboard-list"></div>
      </div>
      <div>
        <button class="btn btn-primary" id="save-btn">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…ØªÛŒØ§Ø²</button>
      </div>
    </div>
  </div>

  <script>
    // Player phone storage
    let playerPhone = localStorage.getItem('playerPhone');
    let hasPlayedGame = localStorage.getItem('hasPlayedGame');
    
    // Welcome screen logic
    document.getElementById('start-game-btn').addEventListener('click', () => {
      const phoneInput = document.getElementById('phone-input');
      const phone = phoneInput.value.trim();
      
      // Check if player has already played
      if (hasPlayedGame) {
        alert('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯');
        return;
      }
      
      if (!playerPhone && (!phone || phone.length < 10)) {
        alert('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        return;
      }
      
      if (!playerPhone && phone) {
        localStorage.setItem('playerPhone', phone);
        playerPhone = phone;
      }
      
      document.getElementById('welcome-screen').style.display = 'none';
      initializeGame();
    });
    
    // If player phone exists, hide phone input
    if (playerPhone) {
      document.getElementById('phone-container').style.display = 'none';
    }

    // If player has played, change welcome screen
    if (hasPlayedGame) {
      document.getElementById('start-game-btn').style.display = 'none';
      const welcomeTitle = document.querySelector('.welcome-title');
      welcomeTitle.textContent = 'Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø§ÛŒÙ† Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯';
      welcomeTitle.style.color = '#f1c40f';
      if (playerPhone) {
        document.getElementById('phone-container').style.display = 'none';
      }
    }

    // --- Loading System ---
    class LoadingManager {
      constructor() {
        this.progress = 0;
        this.loadingSteps = [
          { name: 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ...', duration: 500 },
          { name: 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµØ§ÙˆÛŒØ± Ù…Ø§Ø´ÛŒÙ†â€ŒÙ‡Ø§...', duration: 800 },
          { name: 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø§ÙˆØ±Ø¢Ù¾â€ŒÙ‡Ø§...', duration: 600 },
          { name: 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ...', duration: 400 },
          { name: 'Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø§Ø¯Ù‡...', duration: 300 },
          { name: 'ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§Ø²ÛŒ...', duration: 400 }
        ];
        this.currentStep = 0;
      }

      async start(isFirstLoad) {
        if (!isFirstLoad) {
          document.getElementById('loading-screen').style.display = 'none';
          document.getElementById('game-wrapper').style.display = 'flex';
          return;
        }

        document.getElementById('loading-screen').style.display = 'flex';
        const progressBar = document.getElementById('loading-progress');
        const loadingText = document.querySelector('.loading-text');
        
        for (let i = 0; i < this.loadingSteps.length; i++) {
          const step = this.loadingSteps[i];
          loadingText.textContent = step.name;
          
          await this.simulateLoading(step.duration, (progress) => {
            const totalProgress = ((i + progress) / this.loadingSteps.length) * 100;
            progressBar.style.width = totalProgress + '%';
          });
        }
        
        loadingText.textContent = 'âœ… Ø¨Ø§Ø²ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!';
        await new Promise(resolve => setTimeout(resolve, 500));
        
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('game-wrapper').style.display = 'flex';
        localStorage.setItem('gameLoaded', 'true');
      }

      simulateLoading(duration, onProgress) {
        return new Promise(resolve => {
          let elapsed = 0;
          const interval = setInterval(() => {
            elapsed += 50;
            const progress = Math.min(elapsed / duration, 1);
            onProgress(progress);
            
            if (progress >= 1) {
              clearInterval(interval);
              resolve();
            }
          }, 50);
        });
      }
    }

    // --- Leaderboard and API System ---
    const LB_KEY = 'laneCarLeaderboard_v3';
    let leaderboard = [];
    let currentPlayerScore = 0;
    let currentPlayerName = null;
    
    const API = {
      async getLeaderboard() {
        return new Promise((resolve) => {
          setTimeout(() => resolve(leaderboard), 100);
        });
      },
      async saveScore(name, score) {
        return new Promise((resolve) => {
          setTimeout(() => resolve({success: true, id: Date.now()}), 200);
        });
      }
    };

    function loadLeaderboard() {
      try {
        const raw = localStorage.getItem(LB_KEY);
        leaderboard = raw ? JSON.parse(raw) : [
          {name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§', score: 20},
          {name: 'Ø³Ø§Ø±Ø§ Ø§Ø­Ù…Ø¯ÛŒ', score: 14},
          {name: 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†ÛŒ', score: 12},
          {name: 'ÙØ§Ø·Ù…Ù‡ Ú©Ø±ÛŒÙ…ÛŒ', score: 11},
          {name: 'Ø­Ø³ÛŒÙ† Ù…Ø­Ù…Ø¯ÛŒ', score: 10},
          {name: 'Ù…Ø±ÛŒÙ… Ø±Ø¶Ø§ÛŒÛŒ', score: 9},
          {name: 'Ø§Ù…ÛŒØ± Ø¹Ù„ÛŒ', score: 8},
          {name: 'Ù†Ø§Ø²Ù†ÛŒÙ† ÛŒÙˆØ³ÙÛŒ', score: 7},
          {name: 'Ø±Ø¶Ø§ Ø§ØµØºØ±ÛŒ', score: 6},
          {name: 'Ø²Ù‡Ø±Ø§ Ù…ÙˆØ³ÙˆÛŒ', score: 5}
        ];
      } catch (e) { 
        leaderboard = [
          {name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§', score: 20},
          {name: 'Ø³Ø§Ø±Ø§ Ø§Ø­Ù…Ø¯ÛŒ', score: 14},
          {name: 'Ù…Ø­Ù…Ø¯ Ø­Ø³Ù†ÛŒ', score:12},
          {name: 'ÙØ§Ø·Ù…Ù‡ Ú©Ø±ÛŒÙ…ÛŒ', score: 10},
          {name: 'Ø­Ø³ÛŒÙ† Ù…Ø­Ù…Ø¯ÛŒ', score: 9}
        ];
      }
      if (!Array.isArray(leaderboard)) leaderboard = [];
    }

    async function saveLeaderboardEntry(name, score) {
      try {
        await API.saveScore(name, score);
        leaderboard.push({ name: name || 'Ø¨Ø§Ø²ÛŒÚ©Ù† Ù†Ø§Ø´Ù†Ø§Ø³', score: score || 0, timestamp: Date.now() });
        leaderboard.sort((a,b) => b.score - a.score);
        leaderboard = leaderboard.slice(0, 100);
        localStorage.setItem(LB_KEY, JSON.stringify(leaderboard));
        localStorage.setItem('hasPlayedGame', 'true');
        currentPlayerName = name;
        updateGameOverLeaderboard();
        return true;
      } catch (error) {
        console.error('Failed to save score:', error);
        leaderboard.push({ name: name || 'Ø¨Ø§Ø²ÛŒÚ©Ù† Ù†Ø§Ø´Ù†Ø§Ø³', score: score || 0, timestamp: Date.now() });
        leaderboard.sort((a,b) => b.score - a.score);
        leaderboard = leaderboard.slice(0, 100);
        localStorage.setItem(LB_KEY, JSON.stringify(leaderboard));
        localStorage.setItem('hasPlayedGame', 'true');
        currentPlayerName = name;
        updateGameOverLeaderboard();
        return false;
      }
    }

    function updateGameOverLeaderboard() {
      const list = document.getElementById('game-over-leaderboard-list');
      list.innerHTML = '';
      let displayEntries = [...leaderboard].sort((a,b) => b.score - a.score).slice(0, 10);
      if (currentPlayerName && currentPlayerScore > 0) {
        const playerEntry = { name: currentPlayerName, score: currentPlayerScore };
        const playerRank = getPlayerRank(currentPlayerScore);
        if (playerRank > 10) {
          displayEntries.push({ ...playerEntry, isCurrentPlayer: true, rank: playerRank });
        }
      }
      displayEntries.forEach((entry, i) => {
        const row = document.createElement('div');
        row.className = 'entry';
        const isCurrentPlayer = entry.isCurrentPlayer || (currentPlayerName && entry.name === currentPlayerName && Math.abs(entry.score - currentPlayerScore) < 10);
        if (isCurrentPlayer) row.className += ' current-player';
        const rank = entry.rank || (i + 1);
        const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `${rank}.`;
        row.innerHTML = `<span class="player-rank">${rankEmoji}</span><span class="player-name">${escapeHtml(entry.name)}</span><span class="entry-score">${entry.score}</span>`;
        list.appendChild(row);
      });
    }

    function getPlayerRank(score) {
      const sortedScores = [...leaderboard].sort((a,b) => b.score - a.score);
      let rank = sortedScores.findIndex(entry => score > entry.score);
      if (rank === -1) rank = sortedScores.length;
      return rank + 1;
    }

    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }

    // --- Game size calculation ---
function getGameSize() {
  // Ø¨Ø±Ø§ÛŒ Ø¯Ø³Ú©ØªØ§Ù¾ Ø§Ø² Ù†Ø³Ø¨Øª portrait Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
  if (window.innerWidth > 768) {
    return {
      width: 450,
      height: window.innerHeight
    };
  }
  // Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§Ø² Ú©Ù„ ØµÙØ­Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
  return {
    width: window.innerWidth,
    height: window.innerHeight
  };
}

    // --- Enhanced Phaser Scene ---
    class MainScene extends Phaser.Scene {
      constructor(){ super({ key: 'MainScene' }); }
preload() {
  this.load.on('progress', (value) => console.log('Loading progress:', Math.round(value * 100) + '%'));
  this.load.image('player-car', 'assets/images/cars/player-car.png');
  this.load.image('obstacle-1', 'assets/images/cars/Obstacle1.png');
  this.load.image('obstacle-2', 'assets/images/cars/Obstacle2.png');
  for(let i = 1; i <= 5; i++) this.load.image(`powerup-${i}`, `assets/images/powerups/Powerup${i}.png`);
  for(let i = 1; i <= 4; i++) this.load.image(`text-${i}`, `assets/images/text/text_${i}.png`);
  this.load.image('logo', 'assets/images/ui/logo 002_vz.png');
  this.load.image('road-texture', 'assets/images/road/road.png');
  this.load.audio('background-music', ['assets/SoundVfx/Music.ogg', 'assets/SoundVfx/Music.mp3']);
  this.load.audio('obstacle-sound', 'assets/SoundVfx/Obstacle.ogg');
  this.load.audio('powerup-sound', 'assets/SoundVfx/PechPech.ogg');
  this.load.on('loaderror', (file) => console.warn('Failed to load:', file.src));
}
     create() {
  const w = this.scale.width;
  const h = this.scale.height;
  this.createBackground(w, h);
  this.roadOffset = 0;
  
  // Two lane road setup
  this.lanes = [w * 0.35, w * 0.65]; // Only 2 lanes
  this.laneIndex = 0; // Start in left lane
  
  this.createPlayer(w, h);
  this.obstacles = this.physics.add.group();
  this.powerUps = this.physics.add.group();
  this.bonusTexts = this.physics.add.group();
  this.setupCollisions();
  this.setupControls();
  this.initializeGameState();
  this.setupSpawners();
  this._updateUI();
  loadLeaderboard();
  this.music = this.sound.add('background-music', { loop: true, volume: 0.5 });
  this.music.play();
  this.physics.pause();
  this.startCountdown();
}
      
startCountdown() {
  let count = 3;
  const countdownText = this.add.text(
    this.scale.width / 2,
    this.scale.height / 2,
    '3',
    { 
      fontFamily: 'Digi Sarvenaz',   // ğŸ‘ˆ Ø§ÛŒÙ†Ø¬Ø§ ÙÙˆÙ†Øª Ø¬Ø¯ÛŒØ¯
      fontSize: '72px',
      fill: '#ffffff',
      fontWeight: 'bold',
      stroke: '#000',
      strokeThickness: 4
    }
  );

  countdownText.setOrigin(0.5);

  const timer = this.time.addEvent({
    delay: 1000,
    repeat: 2,
    callback: () => {
      count--;
      countdownText.setText(count.toString());
      if (count === 0) {
        countdownText.setText('Ø´Ø±ÙˆØ¹!');
        this.time.delayedCall(1000, () => {
          countdownText.destroy();
          this.physics.resume();
          this.obstacleTimer.paused = false;
        });
      }
    },
    callbackScope: this
  });

  this.obstacleTimer.paused = true;
}

      
createBackground(w, h) {
  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø±ØªÙØ§Ø¹ ÙˆØ§Ù‚Ø¹ÛŒ ØµÙØ­Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ Ø¬Ø§ÛŒ scale.height
  const actualHeight = window.innerHeight;
  
  this.roadTexture = this.add.tileSprite(0, 0, w, actualHeight, 'road-texture');
  this.roadTexture.setOrigin(0, 0);
  this.roadTexture.setDepth(-1);
  
  const textureWidth = this.textures.get('road-texture').getSourceImage().width;
  const textureHeight = this.textures.get('road-texture').getSourceImage().height;
  
  const scaleX = w / textureWidth;
  const scaleY = actualHeight / textureHeight;
  
  this.roadTexture.setTileScale(scaleX, scaleY);
  this.roadTexture.setDisplaySize(w, actualHeight);
}
      
      createPlayer(w, h) {
        const carWidth = Math.min(70, w * 0.14);
        const carHeight = carWidth * 1.9;
        if (this.textures.exists('player-car')) {
          this.player = this.physics.add.sprite(this.lanes[this.laneIndex], h - 120, 'player-car');
          this.player.setDisplaySize(carWidth + 45, carHeight);
        } else {
          this.createFallbackTextures();
          this.player = this.physics.add.sprite(this.lanes[this.laneIndex], h - 120, 'player-car-fallback');
        }
        this.player.setDepth(5);
        this.player.body.setImmovable(true);
        this.player.body.setCollideWorldBounds(true);
        this.tweens.add({
          targets: this.player,
          y: this.player.y - 3,
          duration: 1000,
          yoyo: true,
          repeat: -1,
          ease: 'Sine.easeInOut'
        });
      }
      
      setupCollisions() {
        this.physics.add.overlap(this.player, this.obstacles, this.onCarCrash, null, this);
        this.physics.add.overlap(this.player, this.powerUps, this.onPowerUpCollected, null, this);
        this.physics.add.overlap(this.player, this.bonusTexts, this.onBonusTextCollected, null, this);
      }
      
      setupControls() {
        this.cursors = this.input.keyboard.createCursorKeys();
        this.wasd = this.input.keyboard.addKeys('W,S,A,D');
        this.input.on('pointerdown', (pointer) => {
          const centerX = this.scale.width * 0.5;
          if (pointer.x < centerX - 50) this.moveLeft();
          else if (pointer.x > centerX + 50) this.moveRight();
        });
        let startX = 0;
        this.input.on('pointerdown', (pointer) => { startX = pointer.x; });
        this.input.on('pointerup', (pointer) => {
          const deltaX = pointer.x - startX;
          if (Math.abs(deltaX) > 50) {
            if (deltaX < 0) this.moveLeft();
            else this.moveRight();
          }
        });
      }
      
      initializeGameState() {
        this.score = 0;
        this.lives = 3;
        this.maxLives = 3;
        this.speed = 2.0; // Changed from 1.0 to 2.0 for double initial speed
        this.baseObstacleSpeed = 360; // Changed from 180 to 360 for double speed
        this.maxSpeed = 9.0; // Changed from 4.5 to 9.0 for double max speed
        this.scoreMultiplier = 1;
        this.powerUpActive = false;
        this.powerUpTimeRemaining = 0;
        this.difficultyLevel = 1;
        this.obstaclesAvoided = 0;
        this.moveCooldown = false;
        this.invulnerabilityTime = 0;
      }
      
      setupSpawners() {
        this.obstacleSpawnDelay = 1800;
        this.obstacleTimer = this.time.addEvent({
          delay: this.obstacleSpawnDelay,
          startAt: 3000,
          loop: true,
          callback: this.spawnObstacle,
          callbackScope: this
        });
        this.powerUpTimer = this.time.addEvent({
          delay: 1700,
          loop: true,
          callback: this.spawnPowerUp,
          callbackScope: this
        });
        this.speedTimer = this.time.addEvent({
          delay: 6000,
          loop: true,
          callback: this.increaseSpeed,
          callbackScope: this
        });
        this.bonusTextTimer = this.time.addEvent({
          delay: 12000,
          loop: true,
          callback: this.spawnBonusText,
          callbackScope: this
        });
      }
      
update(time, delta) {
  if (this.cursors.left.isDown || this.wasd.A.isDown) this.moveLeft();
  else if (this.cursors.right.isDown || this.wasd.D.isDown) this.moveRight();

  // âœ¨ Ú†Ø´Ù…Ú© Ø²Ø¯Ù† Ø¯Ø± Ø­Ø§Ù„Øª invulnerability
  if (this.invulnerabilityTime > 0) {
    this.invulnerabilityTime -= delta;
    this.player.setAlpha(Math.sin(time * 0.01) > 0 ? 0.5 : 1.0);
  } else {
    this.player.setAlpha(1.0);
  }

  // âœ¨ ØªØ§ÛŒÙ…Ø± Ù¾Ø§ÙˆØ±Ø¢Ù¾
  if (this.powerUpActive && this.powerUpTimeRemaining > 0) {
    this.powerUpTimeRemaining -= delta;
    if (this.powerUpTimeRemaining <= 0) this.deactivatePowerUp();
  }

  // ğŸ›£ Ø³Ø±Ø¹Øª Ù…Ø´ØªØ±Ú© - Ø­Ø§Ù„Ø§ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¨Ø§ Ø§ÛŒÙ† Ø³Ø±Ø¹Øª Ø­Ø±Ú©Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
  const worldSpeed = this.baseObstacleSpeed * (delta / 800);

  // Ø­Ø±Ú©Øª Ø¬Ø§Ø¯Ù‡
  this.roadTexture.tilePositionY += -worldSpeed*2 ;

  // Ø­Ø±Ú©Øª Ù…ÙˆØ§Ù†Ø¹ - Ø­Ø§Ù„Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ø§ worldSpeed
  this.obstacles.getChildren().forEach(obstacle => {
    obstacle.y += worldSpeed/1.2;
    if (obstacle.y > this.scale.height ) {
      this.obstaclesAvoided++;
      this._updateUI();
      obstacle.destroy();
    }
  });

  // Ø­Ø±Ú©Øª powerups Ø¨Ø§ Ù‡Ù…Ø§Ù† Ø³Ø±Ø¹Øª Ø¬Ø§Ø¯Ù‡ Ùˆ Ù…ÙˆØ§Ù†Ø¹
  this.powerUps.getChildren().forEach(powerUp => {
    powerUp.y += worldSpeed/1.2;
    if (powerUp.y > this.scale.height ) {
      powerUp.destroy();
    }
  });

  // Ø­Ø±Ú©Øª bonus texts
  this.bonusTexts.getChildren().forEach(bonusText => {
    bonusText.y += worldSpeed;
    if (bonusText.y > this.scale.height + 100) {
      bonusText.destroy();
    }
  });

  // âœ¨ Ø³Ø®ØªÛŒ Ù…Ø±Ø­Ù„Ù‡
  this.updateDifficulty();
}

moveLeft() {
  if (this.moveCooldown || this.laneIndex <= 0) return;
  this.laneIndex--;
  this.tweenPlayerToLane();
  this.setMoveCooldown();
}

moveRight() {
  if (this.moveCooldown || this.laneIndex >= this.lanes.length - 1) return;
  this.laneIndex++;
  this.tweenPlayerToLane();
  this.setMoveCooldown();
}

tweenPlayerToLane() {
  this.tweens.add({
    targets: this.player,
    x: this.lanes[this.laneIndex],
    duration: 150,
    ease: 'Back.easeOut'
  });
}

setMoveCooldown() {
  this.moveCooldown = true;
  this.time.delayedCall(200, () => this.moveCooldown = false);
}

spawnObstacle() {
  const activeObstacles = this.obstacles.getChildren()
    .filter(o => o.y > -100 && o.y < this.scale.height + 100);

  // Ø­Ø¯Ø§Ú©Ø«Ø± 2 Ù…Ø§Ù†Ø¹ Ù‡Ù…Ø²Ù…Ø§Ù†
  if (activeObstacles.length >= 2) return;

  // Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ØµÙ„Ù‡ Ø¨Ø§ Ø¢Ø®Ø±ÛŒÙ† Ù…Ø§Ù†Ø¹
  const lastObstacle = activeObstacles[activeObstacles.length - 1];
  if (lastObstacle && (this.scale.height - lastObstacle.y) < 200) {
    return; // ÙØ§ØµÙ„Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª
  }

  // Ø§Ù†ØªØ®Ø§Ø¨ Ù„Ø§ÛŒÙ†
  let availableLanes = [0, 1];
  // âŒ Ù†Ø°Ø§Ø± Ø¯Ùˆ Ù…Ø§Ù†Ø¹ Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ùˆ Ø·Ø±Ù Ø¨ÛŒØ§Ù†
  if (activeObstacles.length === 1) {
    availableLanes = [activeObstacles[0].laneIndex]; // ÙÙ‚Ø· Ù‡Ù…ÙˆÙ† Ø³Ù…Øª ØªÚ©Ø±Ø§Ø± Ø´Ù‡
  }

  const laneIndex = Phaser.Math.RND.pick(availableLanes);
  const x = this.lanes[laneIndex];

  const obstacleType = Phaser.Math.Between(1, 2);
  const obstacleKey = `obstacle-${obstacleType}`;

  const carWidth = Math.min(55, this.scale.width * 0.11) * 1.7;
  const carHeight = carWidth * 1.7;

  let obstacle;
  if (this.textures.exists(obstacleKey)) {
    obstacle = this.obstacles.create(x, -120, obstacleKey);
    obstacle.setDisplaySize(carWidth, carHeight);
  } else {
    obstacle = this.obstacles.create(x, -120, 'obstacle-fallback');
  }

  obstacle.setDepth(4);
  obstacle.laneIndex = laneIndex;
}

spawnPowerUp() {
  const activeObstacles = this.obstacles.getChildren()
    .filter(o => o.y > -100 && o.y < this.scale.height + 100);

  const activePowerUps = this.powerUps.getChildren()
    .filter(p => p.y > -100 && p.y < this.scale.height + 100);

  // Ø­Ø¯Ø§Ú©Ø«Ø± 1 Ù¾Ø§ÙˆØ±Ø¢Ù¾ Ù‡Ù…Ø²Ù…Ø§Ù†
  if (activePowerUps.length >= 2) return;

  // ÙØ§ØµÙ„Ù‡ Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ù…Ø§Ù†Ø¹
  const lastObstacle = activeObstacles[activeObstacles.length - 1];
  if (lastObstacle && (-120 - lastObstacle.y) < 200) {
    return; // Ù†Ø²Ø¯ÛŒÚ© Ù…Ø§Ù†Ø¹ Ù†Ø¨Ø§Ø´Ù‡
  }

  // Ø§Ù†ØªØ®Ø§Ø¨ Ù„Ø§ÛŒÙ† â†’ Ù„Ø§ÛŒÙ†ÛŒ Ú©Ù‡ Ù…Ø§Ù†Ø¹ ØªÙˆØ´ Ù†Ø¨Ø§Ø´Ù‡
  let availableLanes = [0, 1];
  activeObstacles.forEach(o => {
    availableLanes = availableLanes.filter(l => l !== o.laneIndex);
  });

  if (availableLanes.length === 0) return;

  const laneIndex = Phaser.Math.RND.pick(availableLanes);
  const x = this.lanes[laneIndex];

  const powerUpType = Math.random() < 0.4 ? 'star' : 'text';
  let powerUp;

  if (powerUpType === 'star') {
    const starType = Phaser.Math.Between(1, 5);
    const starKey = `powerup-${starType}`;

    if (this.textures.exists(starKey)) {
      powerUp = this.powerUps.create(x, -120, starKey);
      powerUp.setDisplaySize(25, 25);
      powerUp.powerUpType = starType;
    } else {
      powerUp = this.powerUps.create(x, -120, 'powerup-fallback');
      powerUp.powerUpType = 1;
    }

    powerUp.setDepth(3);
    powerUp.laneIndex = laneIndex;

    this.tweens.add({ 
      targets: powerUp, 
      scaleX: 0.20,
      scaleY: 0.20,
      duration: 1500, 
      yoyo: true, 
      repeat: -1, 
      ease: 'Sine.easeInOut' 
    });
  }
}

spawnBonusText() {
  const textType = Phaser.Math.Between(1, 4);
  const textKey = `text-${textType}`;
  const laneIndex = Phaser.Math.Between(0, 1);
  const x = this.lanes[laneIndex];
  let bonusText;
  
  if (this.textures.exists(textKey)) {
    bonusText = this.bonusTexts.create(x, -120, textKey);
    bonusText.setDisplaySize(70, 35);
  } else {
    bonusText = this.add.text(x, -120, 'BONUS!', { 
      fontSize: '22px', 
      fill: '#f1c40f', 
      fontWeight: 'bold', 
      stroke: '#000', 
      strokeThickness: 2 
    });
    bonusText.setOrigin(0.5);
    this.physics.add.existing(bonusText);
    this.bonusTexts.add(bonusText);
  }
  
  bonusText.setDepth(3);
  // âŒ Ø­Ø°Ù velocity - Ø­Ø§Ù„Ø§ Ø¯Ø± update() Ø¨Ø§ worldSpeed Ø­Ø±Ú©Øª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
  
  this.tweens.add({ 
    targets: bonusText, 
    y: bonusText.y - 15, 
    duration: 1000, 
    yoyo: true, 
    repeat: -1, 
    ease: 'Sine.easeInOut' 
  });
}

// âœ¨ ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§ÛŒÙ…Ø±Ù‡Ø§ÛŒ spawn
setupSpawnTimers() {
  // ØªØ§ÛŒÙ…Ø± Ù…ÙˆØ§Ù†Ø¹
  this.obstacleTimer = this.time.addEvent({
    delay: this.obstacleSpawnDelay,
    loop: true,
    callback: this.spawnObstacle,
    callbackScope: this
  });

  // âœ¨ ØªØ§ÛŒÙ…Ø± PowerUp - Ø­Ø§Ù„Ø§ Ù…Ø¬Ø²Ø§ Ùˆ Ø¨ÛŒØ´ØªØ± spawn Ù…ÛŒâ€ŒØ´ÙˆØ¯
  this.powerUpTimer = this.time.addEvent({
    delay: 2000, // Ù‡Ø± 2 Ø«Ø§Ù†ÛŒÙ‡ Ø´Ø§Ù†Ø³ spawn
    loop: true,
    callback: () => {
      // 60% Ø´Ø§Ù†Ø³ spawn Ú©Ø±Ø¯Ù† PowerUp
      if (Math.random() < 0.6) {
        this.spawnPowerUp();
      }
    },
    callbackScope: this
  });

  // ØªØ§ÛŒÙ…Ø± BonusText
  this.bonusTextTimer = this.time.addEvent({
    delay: 4000, // Ù‡Ø± 4 Ø«Ø§Ù†ÛŒÙ‡
    loop: true,
    callback: () => {
      // 40% Ø´Ø§Ù†Ø³ spawn Ú©Ø±Ø¯Ù† BonusText
      if (Math.random() < 0.4) {
        this.spawnBonusText();
      }
    },
    callbackScope: this
  });
}

onCarCrash(player, obstacle) {
  if (this.invulnerabilityTime > 0) return;
  obstacle.destroy();
  this.lives--;
  this._updateUI();
  this.invulnerabilityTime = 2000;
  this.cameras.main.shake(400, 0.03);
  const flash = this.add.graphics();
  flash.fillStyle(0xff0000, 0.5);
  flash.fillRect(0, 0, this.scale.width, this.scale.height);
  flash.setDepth(10);
  this.tweens.add({ targets: flash, alpha: 0, duration: 300, onComplete: () => flash.destroy() });
  player.setTint(0xff0000);
  this.time.delayedCall(300, () => player.clearTint());
  this.showFloatingText('-1 Ø¬Ø§Ù†', player.x, player.y - 50, 0xff0000);
  this.sound.play('obstacle-sound', { volume: 0.8 });
  this.time.delayedCall(200, () => { if (this.lives <= 0) this.gameOver(); });
}

onPowerUpCollected(player, powerUp) {
  const key = powerUp.texture.key;
  console.log('Collected:', powerUp.texture.key);
  powerUp.destroy();

  let points = 1;

  if (key === 'powerup-1') {
    points = 2;
    this.activatePowerUp();
  } else {
    points = 1;
    this.showRandomTextEffect();
  }

  this.score += points;

  this.showFloatingText('+' + points, powerUp.x, powerUp.y, 0xf1c40f);
  this.showPowerUpEffect(powerUp.x, powerUp.y);
  this.sound.play('powerup-sound', { volume: 0.8 });
  this._updateUI();
}

onBonusTextCollected(player, bonusText) {
  bonusText.destroy();
  const points = 3;
  this.score += points;
  this.showFloatingText('+' + points, bonusText.x, bonusText.y, 0x00ff88);
  this.showPowerUpEffect(bonusText.x, bonusText.y);
  this.sound.play('powerup-sound', { volume: 0.8 });
  this._updateUI();
}

activatePowerUp() {
  this.scoreMultiplier = 2;
  this.powerUpActive = true;
  this.powerUpTimeRemaining = 1500;
  this.player.setTint(0xf1c40f);
  this.showRandomTextEffect();
  document.getElementById('ui-powerup').style.display = 'block';
}

deactivatePowerUp() {
  this.scoreMultiplier = 1;
  this.powerUpActive = false;
  this.powerUpTimeRemaining = 0;
  this.player.clearTint();
  document.getElementById('ui-powerup').style.display = 'none';
}

showRandomTextEffect() {
  const x = this.player.x;
  const y = this.player.y - 100;
  const textTypes = [1, 2, 3, 4];
  const randomText = `text-${Phaser.Math.RND.pick(textTypes)}`;
  const textSprite = this.add.image(x, y, randomText);
  textSprite.setDepth(10);
  textSprite.setDisplaySize(120, 140);

  this.tweens.add({
    targets: textSprite,
    y: y - 50,
    alpha: 0,
    duration: 1500,
    onComplete: () => textSprite.destroy()
  });
}

showFloatingText(text, x, y, color) {
  const floatingText = this.add.text(x, y, text, { 
    fontSize: '18px', 
    fill: `#${color.toString(16).padStart(6, '0')}`, 
    fontWeight: 'bold', 
    stroke: '#000', 
    strokeThickness: 2, 
    fontFamily: 'DigiSarvenaz, Arial' 
  });
  floatingText.setOrigin(0.5);
  floatingText.setDepth(10);
  this.tweens.add({ 
    targets: floatingText, 
    y: y - 80, 
    alpha: 0, 
    duration: 1500, 
    ease: 'Power2', 
    onComplete: () => floatingText.destroy() 
  });
}

showPowerUpEffect(x, y) {
  for (let i = 0; i < 8; i++) {
    const sparkle = this.add.graphics();
    sparkle.fillStyle(0xf1c40f, 1);
    sparkle.fillCircle(0, 0, 4);
    sparkle.x = x;
    sparkle.y = y;
    sparkle.setDepth(8);
    const angle = (i / 8) * Math.PI * 2;
    const distance = Phaser.Math.Between(30, 60);
    this.tweens.add({ 
      targets: sparkle, 
      x: x + Math.cos(angle) * distance, 
      y: y + Math.sin(angle) * distance, 
      alpha: 0, 
      scaleX: 0, 
      scaleY: 0, 
      duration: 800, 
      ease: 'Power2', 
      onComplete: () => sparkle.destroy() 
    });
  }
}

increaseSpeed() {
  if (this.speed < this.maxSpeed) {
    this.speed += 0.15;
    if (this.obstacleSpawnDelay > 600) {
      this.obstacleSpawnDelay = Math.max(600, this.obstacleSpawnDelay - 150);
      this.obstacleTimer.reset({ 
        delay: this.obstacleSpawnDelay, 
        loop: true, 
        callback: this.spawnObstacle, 
        callbackScope: this 
      });
    }
    this._updateUI();
  }
}

updateDifficulty() {
  const newDifficultyLevel = Math.floor(this.obstaclesAvoided / 6) + 1;

  if (newDifficultyLevel > this.difficultyLevel) {
    this.difficultyLevel = newDifficultyLevel;

    // âœ¨ Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ†
    this.showFloatingText(
      `Ø³Ø·Ø­ ${this.difficultyLevel}`,
      this.scale.width / 2,
      this.scale.height / 2,
      0x00ff88
    );

    // ğŸš€ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ø±Ø¹Øª Ù¾Ø§ÛŒÙ‡ - Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¨Ø§Ù‡Ù… Ø³Ø±ÛŒØ¹â€ŒØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯
    this.baseObstacleSpeed += 60;

    // â± Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ú©Ø±Ø¯Ù† ÙØ§ØµÙ„Ù‡â€ŒÛŒ Ø§Ø³Ù¾Ø§ÙˆÙ† Ù…ÙˆØ§Ù†Ø¹
    this.obstacleSpawnDelay = Math.max(300, this.obstacleSpawnDelay - 80);

    // âœ¨ PowerUp spawn Ø®ÛŒÙ„ÛŒ Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø¯Ø± Ø³Ø·ÙˆØ­ Ø¨Ø§Ù„Ø§ØªØ±
    const newPowerUpDelay = Math.max(200, 400 - (this.difficultyLevel * 50)); // Ø­Ø¯Ø§Ù‚Ù„ 200ms
    const newExtraPowerUpDelay = Math.max(250, 600 - (this.difficultyLevel * 60)); // ØªØ§ÛŒÙ…Ø± Ø¯ÙˆÙ…

    // Ø±ÛŒØ³Øª ØªØ§ÛŒÙ…Ø±Ù‡Ø§ Ø¨Ø§ Ø²Ù…Ø§Ù† Ø¬Ø¯ÛŒØ¯
    if (this.obstacleTimer) {
      this.obstacleTimer.reset({
        delay: this.obstacleSpawnDelay,
        loop: true,
        callback: this.spawnObstacle,
        callbackScope: this
      });
    }

    // ØªØ§ÛŒÙ…Ø± Ø§ÙˆÙ„ PowerUp
    if (this.powerUpTimer) {
      this.powerUpTimer.reset({
        delay: newPowerUpDelay,
        loop: true,
        callback: () => {
          // Ø¯Ø± Ø³Ø·ÙˆØ­ Ø¨Ø§Ù„Ø§ØªØ± ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù‡Ù…ÛŒØ´Ù‡ spawn Ù…ÛŒâ€ŒØ´ÙˆØ¯
          const spawnChance = Math.min(0.98, 0.95 + (this.difficultyLevel * 0.01));
          if (Math.random() < spawnChance) this.spawnPowerUp();
        },
        callbackScope: this
      });
    }

    // âœ¨ ØªØ§ÛŒÙ…Ø± Ø¯ÙˆÙ… PowerUp
    if (this.extraPowerUpTimer) {
      this.extraPowerUpTimer.reset({
        delay: newExtraPowerUpDelay,
        loop: true,
        callback: () => {
          const extraSpawnChance = Math.min(0.9, 0.8 + (this.difficultyLevel * 0.02));
          if (Math.random() < extraSpawnChance) this.spawnPowerUp();
        },
        callbackScope: this
      });
    }

    // BonusText Ù‡Ù… Ø®ÛŒÙ„ÛŒ Ø³Ø±ÛŒØ¹â€ŒØªØ± spawn Ø´ÙˆØ¯
    const newBonusDelay = Math.max(800, 1800 - (this.difficultyLevel * 100));
    if (this.bonusTextTimer) {
      this.bonusTextTimer.reset({
        delay: newBonusDelay,
        loop: true,
        callback: () => {
          const bonusChance = Math.min(0.9, 0.75 + (this.difficultyLevel * 0.03));
          if (Math.random() < bonusChance) this.spawnBonusText();
        },
        callbackScope: this
      });
    }
  }
}


      gameOver() {
        [this.obstacleTimer, this.powerUpTimer, this.speedTimer, this.bonusTextTimer].forEach(timer => { if (timer) timer.remove(false); });
        this.physics.pause();
        this.music.stop();
        currentPlayerScore = this.score;
        showGameOver(this.score);
      }

      _updateUI() {
        document.getElementById('ui-score').textContent = `Ø§Ù…ØªÛŒØ§Ø²: ${this.score.toLocaleString()}${this.powerUpActive ? ' (Ø¯ÙˆØ¨Ø±Ø§Ø¨Ø±!)' : ''}`;
        document.getElementById('ui-speed').textContent = `Ø³Ø±Ø¹Øª: ${this.speed.toFixed(1)}`;
        document.getElementById('lives-count').textContent = this.lives;
        this.updateHeartsDisplay();
      }

      updateHeartsDisplay() {
        const heartsContainer = document.getElementById('hearts-container');
        heartsContainer.innerHTML = '';
        for (let i = 0; i < this.maxLives; i++) {
          const heart = document.createElement('div');
          heart.className = 'heart';
          if (i >= this.lives) heart.classList.add('empty');
          heartsContainer.appendChild(heart);
        }
      }

      createFallbackTextures() {
        const carG = this.add.graphics();
        carG.fillStyle(0xe74c3c, 1);
        carG.fillRoundedRect(0, 0, 60, 96, 8);
        carG.fillStyle(0xffffff, 1);
        carG.fillRoundedRect(8, 15, 44, 25, 4);
        carG.fillRoundedRect(8, 50, 44, 20, 4);
        carG.fillStyle(0x2c3e50, 1);
        carG.fillCircle(15, 10, 6);
        carG.fillCircle(45, 10, 6);
        carG.fillCircle(15, 86, 6);
        carG.fillCircle(45, 86, 6);
        carG.generateTexture('player-car-fallback', 60, 96);
        carG.destroy();
        const obsG = this.add.graphics();
        obsG.fillStyle(0x34495e, 1);
       obsG.fillRoundedRect(0, 0, 55 * 1.3, 94 * 1.3, 6);
       obsG.fillStyle(0xffffff, 1);
       obsG.fillRoundedRect(6 * 1.3, 12 * 1.3, 43 * 1.3, 22 * 1.3, 3);
       obsG.fillRoundedRect(6 * 1.3, 45 * 1.3, 43 * 1.3, 18 * 1.3, 3);
       obsG.fillStyle(0x2c3e50, 1);
       obsG.fillCircle(13 * 1.3, 8 * 1.3, 5 * 1.3);
       obsG.fillCircle(42 * 1.3, 8 * 1.3, 5 * 1.3);
       obsG.fillCircle(13 * 1.3, 86 * 1.3, 5 * 1.3);
       obsG.fillCircle(42 * 1.3, 86 * 1.3, 5 * 1.3);
       obsG.generateTexture('obstacle-fallback', 55 * 1.3, 94 * 1.3);
        obsG.destroy();
        const powerG = this.add.graphics();
        powerG.fillStyle(0xf1c40f, 1);
        powerG.fillStar(20, 20, 5, 15, 10, 0);
        powerG.fillStyle(0xffffff, 0.6);
        powerG.fillStar(20, 20, 5, 8, 6, 0);
        powerG.generateTexture('powerup-fallback', 40, 40);
        powerG.destroy();
      }
    }

    let game;

async function initializeGame() {
  const isFirstLoad = !localStorage.getItem('gameLoaded');
  const loadingManager = new LoadingManager();
  await loadingManager.start(isFirstLoad);
  
  const size = getGameSize();
  
  const config = {
    type: Phaser.AUTO,
    parent: 'game-container',
    width: size.width,
    height: size.height,
    backgroundColor: '#000000',
    physics: { 
      default: 'arcade', 
      arcade: { debug: false, gravity: { y: 0 } } 
    },
    scene: MainScene,
    scale: {
      mode: Phaser.Scale.RESIZE,
      autoCenter: Phaser.Scale.CENTER_BOTH,
      width: size.width,
      height: size.height
    }
  };

  game = new Phaser.Game(config);
  setupResizeHandler();
}

function setupResizeHandler() {
  window.addEventListener('resize', () => {
    const size = getGameSize();
    const gameContainer = document.getElementById('game-container');
    const gameWrapper = document.getElementById('game-wrapper');
    
    gameContainer.style.width = size.width + 'px';
    gameContainer.style.height = size.height + 'px';
    
    if (window.innerWidth > 768) {
      gameWrapper.style.width = size.width + 'px';
      gameWrapper.style.height = size.height + 'px';
      gameWrapper.style.top = '50%';
      gameWrapper.style.left = '50%';
      gameWrapper.style.transform = 'translate(-50%, -50%)';
    } else {
      gameWrapper.style.width = size.width + 'px';
      gameWrapper.style.height = size.height + 'px';
      gameWrapper.style.top = '0';
      gameWrapper.style.left = '0';
      gameWrapper.style.transform = 'none';
    }

    if (game && game.scale) {
      game.scale.resize(size.width, size.height);
      
      const scene = game.scene.getScene('MainScene');
      if (scene && scene.roadTexture) {
        scene.roadTexture.setDisplaySize(size.width, size.height);
        scene.roadTexture.setTileScale(
          size.width / scene.textures.get('road-texture').getSourceImage().width,
          size.height / scene.textures.get('road-texture').getSourceImage().height
        );
      }
    }
  });

  window.dispatchEvent(new Event('resize'));
}

    const gameOverModal = document.getElementById('game-over');
    const finalScoreEl = document.getElementById('final-score');
    const playerRankEl = document.getElementById('player-rank-display');

    document.getElementById('save-btn').addEventListener('click', async () => {
      const name = prompt('Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø­Ø¯Ø§Ú©Ø«Ø± 20 Ú©Ø§Ø±Ø§Ú©ØªØ±):') || 'Ø¨Ø§Ø²ÛŒÚ©Ù† Ù†Ø§Ø´Ù†Ø§Ø³';
      const trimmedName = name.trim().substring(0, 20);
      const scene = game.scene.keys['MainScene'];
      const score = scene ? scene.score : currentPlayerScore;
      const saveBtn = document.getElementById('save-btn');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
      saveBtn.disabled = true;
      try {
        await saveLeaderboardEntry(trimmedName, score);
        saveBtn.textContent = 'âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!';
        // Show completion message instead of restart option
        setTimeout(() => {
          gameOverModal.innerHTML = `
            <div class="game-over-logo"></div>
            <h2 style="color: #f1c40f;">ğŸ‰ ØªØ¨Ø±ÛŒÚ©!</h2>
            <p>Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯</p>
            <p style="color: #95a5a6;">Ø§Ø² Ø¨Ø§Ø²ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªØ´Ú©Ø±ÛŒÙ…</p>
          `;
          gameOverModal.className = 'game-completed';
        }, 1000);
      } catch (error) {
        saveBtn.textContent = 'âŒ Ø®Ø·Ø§! Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯';
        setTimeout(() => { saveBtn.textContent = originalText; saveBtn.disabled = false; }, 2000);
      }
    });

    function showGameOver(score) {
      finalScoreEl.textContent = `Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ: ${score.toLocaleString()}`;
      const rank = getPlayerRank(score);
      const totalPlayers = leaderboard.length + 1;
      let rankText = '';
      if (rank === 1) rankText = 'ğŸ¥‡ Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯! Ø±ØªØ¨Ù‡ 1';
      else if (rank <= 3) rankText = `ğŸ† Ø¹Ø§Ù„ÛŒ! Ø±ØªØ¨Ù‡ ${rank} Ø§Ø² ${totalPlayers}`;
      else if (rank <= 10) rankText = `ğŸ‘ Ø®ÙˆØ¨! Ø±ØªØ¨Ù‡ ${rank} Ø§Ø² ${totalPlayers}`;
      else if (score > 100) rankText = `Ø±ØªØ¨Ù‡ ${rank} Ø§Ø² ${totalPlayers}`;
      playerRankEl.textContent = rankText;
      gameOverModal.style.display = 'block';
      updateGameOverLeaderboard();
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadLeaderboard();
    });
  </script>
</body>
</html>